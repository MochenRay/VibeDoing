# 技术选型判断：全景导论

> **源真理版本**：v1.1 (AI生成，基于2026年1月最新实践)
> **更新内容**：Prompt Caching、Structured Output、Agentic 组合方案、成本优化新策略
> **项目定位**：进阶加分——综合决策能力
> **前置项目**：03_Prompt_Engineering、06_RAG与知识库

---

## 一、为什么技术选型很重要？

作为 AI 产品经理，你需要判断：
- 这个需求用 **Prompt** 就能解决，还是需要 **RAG**？
- 要不要做 **Fine-tuning**？成本值不值得？
- 应该选哪个模型？GPT-4 还是更便宜的方案？

**选错的代价**：
- 过度设计 → 成本高、周期长
- 方案不足 → 效果差、体验不好

---

## 二、三种核心方案对比

### 2.1 Prompt Engineering

**原理**：通过设计好的提示词，引导模型输出想要的结果

**成本**：零额外成本（只有 API 调用费）

**2026 新能力**：
- **System Prompt**：系统级指令与用户消息分离，优先级更高
- **Structured Output**：通过 Tool Use / JSON Mode 强制输出格式
- **Prompt Caching**：缓存 System Prompt，大幅降低重复调用成本

**适用场景**：
- 通用任务（翻译、总结、分类）
- 格式转换（文本→JSON）
- 模型本身能力足够的场景

**局限**：
- 无法注入私有知识
- 无法学习特定风格
- 复杂任务可能不稳定

### 2.2 RAG（检索增强生成）

**原理**：先检索知识库，把相关内容作为上下文，再让模型生成

**成本**：中等（Embedding 模型 + 向量数据库 + 大模型）

**2026 进阶架构**：
- **Agentic RAG**：Agent 动态决定检索策略，多知识库智能切换
- **GraphRAG**：知识图谱 + 向量，支持多跳推理
- **Hybrid Search**：向量 + BM25 混合检索，兼顾语义和精确匹配
- **Reranker**：检索后重排序，提升 Top-K 精度

**适用场景**：
- 需要私有知识（企业文档、内部规定）
- 知识需要频繁更新
- 需要准确引用来源

**局限**：
- 检索质量影响最终效果
- 构建和维护知识库有成本
- 不适合需要「创造」的场景

### 2.3 Fine-tuning（微调）

**原理**：用特定数据对模型进行再训练，让模型学会特定任务/风格

**成本**：高（训练数据准备 + 训练费用 + 模型托管）

**适用场景**：
- 需要学习特定风格（企业话术、写作风格）
- 需要高度专业的领域知识
- 调用量大，需要优化成本

**局限**：
- 需要高质量训练数据
- 更新成本高（要重新训练）
- 可能过拟合或遗忘通用能力

### 2.4 对比表

| 维度 | Prompt | RAG | Fine-tuning |
|------|--------|-----|-------------|
| **成本** | 低 | 中 | 高 |
| **实施周期** | 小时级 | 天级 | 周级 |
| **知识更新** | 无需 | 实时 | 重新训练 |
| **私有知识** | ❌ | ✅ | ✅ |
| **特定风格** | 有限 | ❌ | ✅ |
| **可解释性** | 低 | 高（可追溯） | 低 |

### 2.5 成本优化新工具（2026）

#### Prompt Caching（提示词缓存）

**原理**：将重复使用的 System Prompt 缓存起来，后续调用只需传增量内容。

**成本节省**：
- Anthropic Claude：缓存命中后，缓存部分价格降低 **90%**
- OpenAI：支持 Prompt Caching，自动检测重复前缀

**适用场景**：
```
场景：12345 热线事件分类
- System Prompt（固定）：部门职责描述、分类规则、输出格式 → 缓存
- User Message（变化）：每条市民来电内容 → 实时传入

成本计算：
- 无缓存：每条 = 2000 tokens System + 500 tokens User = 2500 tokens
- 有缓存：每条 = 200 tokens (缓存命中) + 500 tokens User = 700 tokens
- 节省：72%
```

**ToG 价值**：政务场景 System Prompt 通常很长（部门职责、政策条款、格式规范），Caching 能大幅降低成本。

#### 模型分层策略

**原理**：不同复杂度的任务用不同成本的模型。

| 任务类型 | 推荐模型 | 成本参考 |
|----------|---------|---------|
| 简单分类/提取 | GPT-4o Mini / Claude Haiku | $0.15/M tokens |
| 中等复杂任务 | GPT-4o / Claude Sonnet | $2.5-3/M tokens |
| 复杂推理/生成 | GPT-4o / Claude Opus | $10-15/M tokens |

**实施方式**：
1. **路由模式**：先用小模型判断任务复杂度，再路由到对应模型
2. **级联模式**：小模型先尝试，置信度低时升级到大模型

---

## 三、选型决策框架

### 3.1 决策树

```
                    用户需求
                       │
        ┌──────────────┼──────────────┐
        ↓              ↓              ↓
   需要私有知识？  需要特定风格？  都不需要？
        │              │              │
        ↓              ↓              ↓
   ┌────┴────┐    ┌────┴────┐    直接用
   知识更新   知识   强需求   弱需求   Prompt
   频繁？     稳定？    │        │
   │         │        ↓        ↓
   ↓         ↓    Fine-tune  Few-shot
  RAG    可考虑              Prompt
         Fine-tune
         或 RAG
```

### 3.2 关键判断问题

| 问题 | 如果「是」| 如果「否」|
|------|---------|---------|
| 需要私有/实时知识？ | → RAG | 可能 Prompt 够用 |
| 需要学习特定风格/格式？ | → Fine-tune 或 Few-shot | 可能 Prompt 够用 |
| 知识会频繁更新？ | → RAG（Fine-tune更新成本高）| 都可以 |
| 预算有限？ | → Prompt > RAG > Fine-tune | 选效果最好的 |
| 调用量很大？ | → 考虑 Fine-tune 小模型降本 | 按效果选 |

### 3.3 组合方案（2026 更新）

很多场景需要组合使用：

| 组合 | 场景 | 说明 |
|------|------|------|
| **RAG + Prompt** | 大多数知识问答场景 | 最常见组合 |
| **RAG + Fine-tune** | 需要特定风格的知识问答 | 检索 + 风格化生成 |
| **Prompt + Agent** | 需要调用工具的复杂任务 | Tool Use 模式 |
| **Agentic RAG** | 多知识库、复杂查询 | Agent 动态选择检索策略 |
| **RAG + MCP** | 需要外部服务集成 | 标准化工具接口 |
| **多 Agent 协作** | 复杂多步骤任务 | 专家分工、层级指挥 |

#### 新兴组合：Agentic RAG

**传统 RAG**：Query → 检索 → 生成（一次性）

**Agentic RAG**：
```
Query → Agent 分析 → 选择知识库 → 检索 → 评估结果
                          ↓
                    结果不够？→ 调整策略重试
                          ↓
                    结果充足 → 生成回答
```

**ToG 场景示例**：
```
用户问：「2024年外来人口落户上海需要什么条件？」

传统 RAG：在「落户政策」库中检索，可能漏掉「人才引进」相关内容

Agentic RAG：
1. Agent 分析：涉及「落户」+「外来人口」
2. 选择检索：「落户政策库」+「人才引进库」+「居住证库」
3. 评估结果：发现「积分落户」和「直接落户」两条路径
4. 综合回答：整合多来源，给出完整方案
```

---

## 四、场景判断练习

### 场景 1：12345 热线事件分类

**需求**：对市民来电自动分类，派发到对应部门

**分析**：
- 需要私有知识？有一点（部门职责边界是私有的）
- 需要特定风格？❌
- 任务复杂度？中等（多分类 + 边界模糊）
- 调用量？大（每天数千条）

**推荐方案**：**Prompt + Few-shot**（如果分类边界复杂，可加 RAG 存储部门职责说明）

**理由**：分类任务 Prompt 通常够用，但需要 Few-shot 覆盖边界 case。如果部门职责描述很长，可用 RAG 检索相关职责说明。

---

### 场景 2：政策法规问答

**需求**：市民/工作人员可以查询政策法规，AI 基于官方文件回答

**分析**：
- 需要私有知识？✅（政策法规是特定的）
- 政策会更新？✅（每年都可能修订）
- 需要准确引用？✅（不能胡说，要有依据）

**推荐方案**：**RAG**

**理由**：
- 私有知识 → 必须用 RAG 或 Fine-tune
- 需要更新 → RAG 更新成本低
- 需要引用 → RAG 可以追溯来源，标注「依据 XX 条例第 X 条」

---

### 场景 3：风险研判报告生成

**需求**：基于多源数据自动生成风险研判报告

**分析**：
- 需要私有知识？✅（历史案例、处置经验）
- 需要特定风格？✅（报告格式固定、用语规范）
- 任务复杂度？高（多步骤、需要推理）

**推荐方案**：**RAG + Prompt Chain**（或 Agent）

**理由**：
- 历史案例检索 → RAG
- 报告格式控制 → Prompt 的格式约束
- 多步骤推理 → Prompt Chain 或 Agent
- 如果报告风格要求极高，可考虑对生成环节 Fine-tune

---

### 场景 4：城市大脑数据分析对话

**需求**：用自然语言查询城市运行数据，获得分析结果

**分析**：
- 需要私有知识？✅（数据库结构、指标定义）
- 需要调用工具？✅（需要执行 SQL 或 API 查询）
- 任务复杂度？高（NL2SQL + 结果解读）

**推荐方案**：**Agent**（Prompt + Tool Calling）

**理由**：
- 需要调用数据库 → Agent 模式
- 指标定义可用 RAG 存储
- 复杂查询可能需要多轮交互

---

### 场景 5：应急指挥辅助决策

**需求**：应急事件发生时，AI 辅助指挥人员快速决策

**分析**：
- 需要私有知识？✅（预案库、历史案例、资源分布）
- 需要实时数据？✅（传感器、现场反馈）
- 决策风险？高（影响重大）

**推荐方案**：**RAG + Agent + 人工确认**

**理由**：
- 预案/案例检索 → RAG
- 资源查询、传播模拟 → Agent 调用工具
- 最终决策 → 必须人工确认（高风险场景）
- 不建议 Fine-tune，因为应急场景变化大，难以覆盖所有情况

---

## 五、决策检查清单

做技术选型时，用这个清单检查：

```markdown
## 技术选型检查清单

### 需求理解
- [ ] 核心问题是什么？
- [ ] 输入是什么？输出是什么？
- [ ] 质量要求是什么？

### 知识需求
- [ ] 需要私有知识吗？
- [ ] 知识会频繁更新吗？
- [ ] 需要准确引用来源吗？

### 风格需求
- [ ] 需要学习特定风格吗？
- [ ] 有足够的风格示例吗？

### 成本约束
- [ ] 预算是多少？
- [ ] 调用量大吗？
- [ ] 对延迟有要求吗？

### 方案评估
- [ ] Prompt 能解决吗？试过 Few-shot 吗？
- [ ] 需要 RAG 吗？知识库好建吗？
- [ ] 需要 Fine-tune 吗？数据够吗？

### 组合考虑
- [ ] 需要组合方案吗？
- [ ] 各环节如何衔接？
```

---

## 六、学习节点说明

基于以上内容，本项目划分为 5 个学习节点：

### A层：理解选项

| 节点 | 核心内容 | 验证输出 |
|------|---------|---------|
| **A1** | 三种方案对比：理解 Prompt/RAG/Fine-tune | 补充 ToG 场景视角的三种方案对比分析 |
| **A2** | 场景判断框架：建立决策树 | 为城市治理 AI 场景设计技术选型决策树 |
| **A3** | 成本优化策略：Caching + 模型分层 🆕 | 为高频政务场景设计成本优化方案 |

### B层：实战练习

| 节点 | 核心内容 | 验证输出 |
|------|---------|---------|
| **B1** | 综合场景练习：5 个 ToG 场景选型判断 🚧 | 完成 5 个 ToG 场景的技术选型判断（含论述理由）|
| **B2** | Agentic 组合方案设计 🆕 | 为多知识库政务场景设计 Agentic RAG 方案 |

---

## 七、前置知识依赖

本项目需要你已掌握：

| 前置项目 | 需要掌握的内容 |
|---------|--------------|
| 03_Prompt_Engineering | Prompt 结构、Few-shot、格式控制 |
| 06_RAG与知识库 | RAG 流程、分块策略、适用场景 |

如果还没完成这些项目，建议先完成再学习本项目。

---

## 八、思考问题

读完这篇导论，尝试不看上文回答：

1. **Prompt、RAG、Fine-tuning 分别适合什么场景？各有什么优缺点？**

2. **如果需求是「政策法规问答」，你会选择哪种方案？为什么？**

3. **如果要做「风险研判报告生成」，需要组合哪些技术方案？为什么？**

4. **如果调用量很大但预算有限，应该如何选型？**

5. **Prompt Caching 在什么场景下最有价值？能节省多少成本？**

6. **Agentic RAG 和传统 RAG 的核心区别是什么？什么时候值得用 Agentic RAG？**

7. **模型分层策略如何实施？什么任务该用小模型，什么任务必须用大模型？**

---

> **下一步**：进入 A1 节点，详细学习三种方案的对比。
