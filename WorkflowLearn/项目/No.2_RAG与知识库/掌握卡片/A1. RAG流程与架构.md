---
node: A1
title: RAG流程与架构
status: mastered
mastered_date: 2026-01-28
next_review: 2026-02-07
last_reviewed: 2026-01-28
---

# A1. RAG 流程与架构

---

## 🎯 核心概念

**RAG（检索增强生成）** = 先检索 + 后生成

```
用户提问 → 检索相关文档 → 拼接 Prompt → 大模型生成回答
```

### 为什么需要 RAG？

| 大模型的问题 | RAG 如何解决 |
|------------|-------------|
| 知识有截止日期 | 检索实时更新的知识库 |
| 不知道私有知识 | 接入企业内部文档 |
| 容易产生幻觉 | 基于真实文档生成，可追溯 |

---

## 完整流程

**离线阶段（建库）**：
```
知识库文档 → 分块(Chunking) → 向量化(Embedding) → 存入向量数据库
```

**在线阶段（查询）**：
```
用户提问 → 向量化 → 相似度检索 → 获取Top-K文档 → 拼接Prompt → 大模型生成
```

---

## 核心机制：语义检索

**传统搜索 vs RAG**：

| 维度 | 传统搜索 | RAG |
|------|---------|-----|
| 匹配方式 | 关键词字符串匹配 | 向量相似度 |
| 理解能力 | 不理解语义 | 理解语义 |
| 召回能力 | 只能找包含关键词的 | 能找语义相关但措辞不同的 |

**例子**：
- 用户问："城市积水怎么办"
- 传统搜索：只能找到包含"积水"的文档
- RAG：能找到"内涝应急预案"（理解语义关联）

---

## 与城市数据管道的对比

| 维度 | 城市数据管道 | RAG 数据管道 |
|------|------------|------------|
| **数据类型** | 结构化数据 | 非结构化文本 |
| **核心转换** | 字段映射、类型转换 | 文本 → 向量（语义表示） |
| **检索方式** | SQL 精确查询 | 向量相似度（语义检索） |
| **清洗需求** | 需要（异常值、重复） | 同样需要（过期文档、乱码、重复版本） |

**关键差异**：精确匹配 vs 语义匹配

---

## 💡 问题诊断

**问题1**：系统返回已废止的文档
- **根因**：数据清洗问题
- **解决**：离线阶段过滤过期文档，或标注版本

**问题2**：用户换个说法就找不到（"积水" vs "内涝"）
- **根因**：Embedding 模型语义理解能力不足
- **解决**：
  1. 换用更强的 Embedding 模型
  2. 优化分块策略（标题+正文在同一 chunk）
  3. 调整 Top-K 和相似度阈值

---

## 💡 实操验证

**场景设计能力**（政策法规问答系统）：
- **分块策略**：标题+第一段作为首 chunk（高概括性），后续按段落拆分，设置重叠防止信息断裂
- **合规意识**：ToG 项目必须使用国产 Embedding 模型，数据安全优先
- **核心洞察**：城市数据管道和 RAG 的本质差异在于"精确匹配 vs 语义匹配"——字符差异不影响 RAG 检索，但会导致传统查询失败

---

## 关联概念

- [[P2. ETL vs AI Pipeline]] - RAG 是 AI Pipeline 的典型应用
- [[P3. 数据质量对RAG的影响]] - 数据清洗同样重要
- [[A2. 向量与Embedding]] - 语义检索的技术基础
